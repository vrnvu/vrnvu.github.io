<!doctype html><html lang=en><head><meta charset=UTF-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>what is async</title><meta name=description><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Jost&display=swap" rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/remixicon@2.5.0/fonts/remixicon.css rel=stylesheet><link href=/css/var.css rel=stylesheet><link href=/css/base.css rel=stylesheet><link href=/css/header.css rel=stylesheet><link href=/css/footer.css rel=stylesheet><link href=/css/post.css rel=stylesheet><script src="https://www.googletagmanager.com/gtag/js?id=G-XQFJ3LKRH8" async></script><script>window.dataLayer = window.dataLayer || [];function gtag(){dataLayer.push(arguments);}gtag('js', new Date());gtag('config', 'G-XQFJ3LKRH8');</script><body><script>if(localStorage.getItem('theme')=='dark'){document.body.classList.add('dark-mode');}</script><header class=blur><div class=top><a class="header blog" href=/blog><i class="ri-terminal-box-line ri-2x"></i><span>Blog</span></a><a class=back href=/><i class="ri-arrow-left-s-line ri-1x"></i><span>Home</span></a><div class=icon><a aria-label=home href=/ id=go-home><i class="ri-user-6-line ri-xl"></i></a><a aria-label="rss feed" href=/blog/atom.xml><i class="ri-rss-line ri-xl"></i></a><button aria-label="dark light mode switch" id=color-toggle><i class="ri-moon-line ri-xl"></i></button><button aria-label="table of content" id=toc-toggle><i class="ri-menu-2-line ri-xl"></i></button></div></div><div id=progress-bar></div></header><div class=wrap><div class=blank></div><main><div id=top></div><article><h1>what is async</h1><div id=post-info><div class=date><span id=publish>2022-06-26</span></div><div class=tags><a class=tag href=https://www.arnaudiaz.com/tags/programming><i class="ri-hashtag ri-sm"></i><span>programming</span></a></div></div><hr><h1 id=what-is-async>What is async?</h1><p>To start, if a function is a routine or a subroutine, then an async function is a coroutine.<p>In the main program, there is a main stack that contains the memory space allocated to execute a function. This space is called a stack frame, and it stores local variables and parameters. The stack also contains the variables and stack frames of the functions being executed.<p>When you return from a function, you get rid of the stack frame from the main stack, and you lose the local variables of that function.<p>In a coroutine, you can pause the execution and return control to where you were before without removing anything from the stack. This is an <code>async</code> function.<p>Let's consider this code snippet, which includes a <code>main</code> function and a <code>foo</code> coroutine that you can pause.<pre class=language-rust data-lang=rust style=background-color:#2e3440;color:#d8dee9;><code class=language-rust data-lang=rust><span style=color:#b48ead;>1</span><span> main () {
</span><span style=color:#b48ead;>2   </span><span style=color:#88c0d0;>foo</span><span>()
</span><span style=color:#b48ead;>3 </span><span>}
</span><span style=color:#b48ead;>4 </span><span style=color:#88c0d0;>foo</span><span>() {
</span><span style=color:#b48ead;>5</span><span>   suspend 
</span><span style=color:#b48ead;>6 </span><span>}
</span></code></pre><p>We can use the <code>async</code> keyword to indicate that <code>foo</code> will give us a pointer to the stack frame of the coroutine. This allows us to return to where we were in the main function. Keep in mind that this behavior is only a convention, and we could return additional data about the coroutine if we wanted to. Similarly, we can use the <code>resume</code> keyword to indicate that we want to return to the stack frame. It's worth noting that this is a syntax convention that I've created.<pre class=language-rust data-lang=rust style=background-color:#2e3440;color:#d8dee9;><code class=language-rust data-lang=rust><span style=color:#b48ead;>1</span><span> main () {
</span><span style=color:#b48ead;>2</span><span>   f </span><span style=color:#81a1c1;>=</span><span> async </span><span style=color:#88c0d0;>foo</span><span>()
</span><span style=color:#b48ead;>3</span><span>   resume </span><span style=color:#88c0d0;>f</span><span>()
</span><span style=color:#b48ead;>4 </span><span>}
</span><span style=color:#b48ead;>5 </span><span style=color:#88c0d0;>foo</span><span>() {
</span><span style=color:#b48ead;>6</span><span>   suspend 
</span><span style=color:#b48ead;>7   </span><span style=color:#81a1c1;>return </span><span style=color:#b48ead;>10
</span><span style=color:#b48ead;>8 </span><span>}
</span></code></pre><ol><li>Begin by loading the main function at LOC 1.<li>The stack contains the execution line and the variables of the main function and its frames.<li>At LOC 2, call the <code>foo()</code> function and save the pointer to the frame.<li>At LOC 6, you are inside the stack frame of <code>foo()</code>, where you make a <code>suspend</code> call and return execution to the caller without popping the frame.<li>At LOC 3, you <code>resume</code> the frame.<li>At LOC 7, you <code>return</code> the value 10 and pop the frame.<li>Now you are at LOC 4. If you had saved the value in a variable, you could use it normally. After all, it's just another variable in the stack, right?</ol><p>How does the following example work? What does it print?<pre class=language-rust data-lang=rust style=background-color:#2e3440;color:#d8dee9;><code class=language-rust data-lang=rust><span style=color:#b48ead;>1</span><span> main () {
</span><span style=color:#b48ead;>2</span><span>   f </span><span style=color:#81a1c1;>=</span><span> async </span><span style=color:#88c0d0;>foo</span><span>()
</span><span style=color:#b48ead;>3</span><span>   v </span><span style=color:#81a1c1;>=</span><span> resume </span><span style=color:#88c0d0;>f</span><span>()
</span><span style=color:#b48ead;>4   </span><span style=color:#88c0d0;>print</span><span>(v)
</span><span style=color:#b48ead;>5 </span><span>}
</span><span style=color:#b48ead;>6 </span><span style=color:#88c0d0;>foo</span><span>() {
</span><span style=color:#b48ead;>7</span><span>   suspend 
</span><span style=color:#b48ead;>8   </span><span style=color:#81a1c1;>return </span><span style=color:#b48ead;>10
</span><span style=color:#b48ead;>9 </span><span>}
</span></code></pre><p>And what about this one? What does it print?<pre class=language-rust data-lang=rust style=background-color:#2e3440;color:#d8dee9;><code class=language-rust data-lang=rust><span style=color:#b48ead;>1</span><span> var global </span><span style=color:#81a1c1;>= </span><span style=color:#b48ead;>0
</span><span style=color:#b48ead;>2</span><span> main () {
</span><span style=color:#b48ead;>3</span><span>   f </span><span style=color:#81a1c1;>= </span><span style=color:#88c0d0;>foo</span><span>()
</span><span style=color:#b48ead;>4   </span><span style=color:#81a1c1;>while </span><span>(global </span><span style=color:#81a1c1;>!= </span><span style=color:#b48ead;>3</span><span>) {
</span><span style=color:#b48ead;>5</span><span>     resume f
</span><span style=color:#b48ead;>6   </span><span>}
</span><span style=color:#b48ead;>7   </span><span style=color:#88c0d0;>print</span><span>(global)
</span><span style=color:#b48ead;>8 </span><span>}
</span><span style=color:#b48ead;>9 </span><span style=color:#88c0d0;>foo</span><span>() {
</span><span style=color:#b48ead;>10   </span><span style=color:#81a1c1;>while </span><span>(</span><span style=color:#b48ead;>1</span><span>) {
</span><span style=color:#b48ead;>10</span><span>     global</span><span style=color:#81a1c1;>++
</span><span style=color:#b48ead;>11</span><span>     suspend
</span><span style=color:#b48ead;>12  </span><span>}
</span><span style=color:#b48ead;>13</span><span>}
</span></code></pre><p>The <code>await</code> keyword causes the program to wait in the main function instead of continuing with the execution. There's nothing mysterious about it, it simply waits for the frame to return. This makes it ideal for IO tasks, where you may need to wait for a response. For example, you might do some work in the background and then await the response.<h2 id=function-coloring>Function coloring</h2><p>The reason that <code>async</code> functions need to go with async is that when managing memory, there can be situations where you have uninitialized variables. If you execute code before the <code>await</code> and after the <code>async</code> function, it could print garbage because there are uninitialized pointers waiting for a value. Sometimes the compiler can detect this, but other times it can't.<p>It's worth noting that we're just using pointers to execute the functions and coroutines. This means that you can run them in any thread or scheduler you need, depending on your requirements.<p>In conclusion, <strong>it's important to understand that coroutines have nothing to do with parallelism</strong>. They are simply a way to manage memory and handle IO tasks in an efficient and elegant way.<h2 id=blocking-non-blocking>Blocking, non-blocking</h2><p>In a subroutine, the caller always waits for the return value. However, with coroutines and <code>async</code> functions, the caller only waits for the result if they use the <code>await</code> keyword. The use of <code>suspend</code> in the function body doesn't determine whether the caller has to block or not.<p><strong>The decision to wait or not is up to the caller</strong>, and whether a function is <code>async</code> or not doesn't determine whether it blocks or is non-blocking. Instead, it's the use of <code>await</code> that matters in determining whether a caller needs to block or not.<h2 id=more>More</h2><p>This post was an introduction with some inaccuracies. Read <a rel="nofollow noreferrer" href=https://arnaudiaz.com/blog/types-of-coroutines/>this</a> for more.</article></main><aside class=blur><nav><ul><li><a class=toc-h2 href=#what-is-async>What is async?</a> <ul><li><a class=toc-h3 href=#function-coloring>Function coloring</a><li><a class=toc-h3 href=#blocking-non-blocking>Blocking, non-blocking</a><li><a class=toc-h3 href=#more>More</a></ul></ul></nav><a aria-label="back to top" href=#top id=back-to-top><i class="ri-arrow-up-s-line ri-2x"></i></a></aside></div><footer><div class=copyright>i don't believe in copyright</div></footer><script src=/js/dark.js></script><script src=/js/toc.js></script><script src=/js/progress.js></script><script src=/js/lightense.min.js></script><script src=/js/img.js></script>